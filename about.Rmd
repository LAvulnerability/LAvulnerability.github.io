---
title: "Proceso de indentificación de shocks exógenos y crisis de crecimiento"
author:
- name: Marcelo Fernández
  affiliation: Universidad de Cuenca
- name: Shakyra Chacón
  affiliation: Universidad de Cuenca
date: "6/19/2020"
output:
  html_document:
    toc: yes
    toc_depth: 5
    toc_float:
      smooth_scroll: no
      collapse: no
    number_sections: yes
abstract: |
  Esta sección desagrega los eventos de shocks para cada variable de interés y la identificación de episodios de crisis de crecimiento dentro de la muestra.
tags:
- nothing
- nothingness
csl: apa.csl
bibliography: referencias.bib
lan: es-Es
---

```{r librerias, message=FALSE, warning=FALSE,echo=FALSE}

rm(list = ls())
library(readxl)
library(tidyverse)
library(reshape2)
library(highcharter)
library(data.table)
library(DT)
library(citr)
options(digits = 2,scipen = 13) #EVITAR QUE SE MUESTRE LOS DATOS EN FORMATO CIENTIFICO
```

```{r Funciones , message=FALSE, warning=FALSE,echo=FALSE}

growth <- function(c){((c-lag(c,n = 1))/lag(c,n = 1))*100}  #FUNCION PARA EL CALCULO DE TASA DE CRECIMIENTO

var <- function(g){(g-lag(g,n = 1))} #FUNCION PARA EL CALCULO DE VARIACION DE DATOS, ES DECIR, `T-T-1`

filtrar <- function(x){ # FUNCION PARA FILTRAR POR CODIGO DE LA BASE COMPLETA Y PONER EN FORMATO LONG
  wdi %>% #Usar la base de datos para los siguientes pasos
    filter(`code`==as.character(x)) %>% #Filtrar los datos para aquellos de la variable `code` tengan el valor de x.
    select(Countries,`1980`:`2018`)%>% #Seleccionar solamente la variable de paises junton con los datos de los anios 1970-2018
    melt(id.vars="Countries",value.name = as.character(x),variable.name="year") %>% #Poner en formato `long`, nombrar a la variable de valor con el mismo nombre del codigo en `x`
    data.table(key = c("Countries","year")) } #Dar formato de tabla para posterior hacer match.

graf_cr <- function(k){ #GRAFICAR LAS CRISIS EN LA IVE
ggplot(ive)+aes(x = year,group=Countries)+
  geom_line(aes(y = gdp_pc,color=Countries),na.rm = TRUE)+
  theme_minimal()+
  scale_x_discrete(breaks=seq(1970,2018,5))+
  scale_y_continuous(limits = c(min(ive$gdp_pc,na.rm = TRUE),max(ive$gdp_pc,na.rm = TRUE)))+
  geom_point(mapping = aes(y = gdp_pc*k),na.rm = TRUE)
}

```

Las variables tienen codificacion propia del WDI de la siguiente forma `(Revisar la metadata adjunta)`[^1]:

[^1]: Se puede comprobar cada código en la pagina oficial del WDI o en google.

| Codigo | Definición |
| ------- | ----------- |
|	DT.ODA.ODAT.GN.ZS |	AOD neta recibida (% del INB)|
|	NY.GDP.MKTP.KD |	PIB (US $ constantes de 2010)|
|	NY.GDP.MKTP.KD.ZG |	Crecimiento del PIB (% anual)|
|	NY.GDP.PCAP.KD |	PIB per cápita (US $ constantes de 2010)|
| NY.GDP.PCAP.KD.ZG |	Crecimiento del PIB per cápita (% anual)|
|	GC.TAX.TOTL.GD.ZS |	Ingresos fiscales (% del PIB)|
|	BN.CAB.XOKA.GD.ZS |	Saldo en cuenta corriente (% del PIB)|
|	IQ.CPA.ECON.XQ |	Promedio del clúster de gestión económica de la CPIA (1 = bajo a 6 = alto)|
|	IQ.CPA.SOCI.XQ |	Políticas de la CPIA para la inclusión social / promedio del grupo de equidad (1 = bajo a 6 = alto)|
|	IQ.CPA.PUBS.XQ |	CPIA gestión del sector público e instituciones promedio de clúster (1 = bajo a 6 = alto)|
|	IQ.CPA.STRC.XQ |	Promedio de clúster de políticas estructurales de la CPIA (1 = bajo a 6 = alto)|
|	BX.KLT.DINV.WD.GD.ZS |	Inversión extranjera directa, entradas netas (% del PIB)|
|	BX.TRF.PWKR.DT.GD.ZS |	Remesas personales, recibidas (% del PIB)|
|	NE.IMP.GNFS.ZS |	Importaciones de bienes y servicios (% del PIB)|
|	NE.EXP.GNFS.ZS |	Exportaciones de bienes y servicios (% del PIB)|
|	FI.RES.TOTL.MO |	Reservas totales en meses de importaciones|
|	NY.TTF.GNFS.KN |	Ajuste de los términos de intercambio (LCU constante)|
|	SI.POV.GINI |	Índice GINI (estimación del Banco Mundial)|
|	NV.AGR.TOTL.ZS |	Agricultura, valor agregado (% del PIB)|

```{r Importacion de datos de WDI, message=FALSE, warning=FALSE,echo=FALSE}
wdi <- read_csv("wdi.csv") #Lista completa de variables del mismo WDI.
paises <- read_csv("Countries_AL.txt") #Lista de paises para filtrar de toda la base de datos completa.

wdi <- wdi %>% 
  mutate_at(.vars = 5:53,.funs = as.numeric) %>% #Poner las columnas 5:53 en formato double.
  select(`Series Code`,`Country Name`,`1970`:`2018`) %>%  #Seleccionar solamente las columnas de interes y la de los anios.
  rename("code"=`Series Code`,"Countries"=`Country Name`) %>%  #Renombrar las variables
  filter(`Countries` %in% paises$Countries) #Filtar para que de todos los paises en la base completa se queden aquellos que estan en el archivo `Countries_AL.txt`.

ggdppc <- filtrar(x = "NY.GDP.PCAP.KD.ZG")
gdppc <- filtrar(x = "NY.GDP.PCAP.KD")

ive <- merge(x = gdppc,y = ggdppc) #el data.frame `ive` contiene solamente el pibpc y su tasa de crecimiento.
rm(list = c("ggdppc","gdppc")) #Eliminar los archivos anteriores para no generar basura.
ive <- rename(ive,"gdp_pc"=`NY.GDP.PCAP.KD`,"g_gdppc"=`NY.GDP.PCAP.KD.ZG`)
#ive %>% hchart(type="line",hcaes(x = year, y = gdp_pc,group=Countries))
```

# Identificación de los shocks en las variables 
Los episodios de shocks involucran al menos una de las siguientes variables:

| Variable | Medida |
| ------ | -------|
| Demanda externa | USD |
| Términos de intercambio | USD |
| IED | %PIB |
| Ayudas | %PIB |
| Remesas | %PIB |
| Desastres naturales | Población y USD |

*Los valores en USD estan en dólares constantes*

El @internationalmonetaryfundManagingVolatilityVulnerability2011 sugiere identificar eventos de shocks externos negativos cuando el cambio porcentual anual de la variable de shock relevante cae por debajo del percentil 10 en la cola izquierda de la distribución específica del **país**[^2]. Es decir,

[^2]: Se realiza por país para mejorar la captura de heterogeneidad propia de cada país con respecto a su estructura económica y vulnerabilidad a shocks exógenos.

![Distrucion de la variable de interés](distribucion_shock.png).

Para el caso de las variables de desastres naturales la regla anterior se modifica. En este caso, se dice que hay un evento de shock exógeno cuando el número de gente afectada y el daño económico se encuentra por encima del percentil 25 de la distribución.

Se excluyen los valores que se encuentran por debajo/encima  de los percentiles $1$ y $99$ para evitar los datos atípicos en la muestra. Los episodios de shock que son contiguos o con menos de tres años de diferencia se registran como un evento de shock sólo el primer año disponible.

## FDI

```{r Variable de FDI ,echo=FALSE,message=FALSE,warning=FALSE }
fdi <- filtrar(x = "BX.KLT.DINV.WD.GD.ZS") #Selccionando la variable de FDI del conjunto compleot del WDI
fdi <- rename(fdi,fdi=BX.KLT.DINV.WD.GD.ZS)
```

### Percentil 10mo para la variación en el FDI para cada pais
```{r percentiles del FDI,echo=FALSE}
fdi <- fdi %>% 
  group_by(`Countries`) %>% 
  mutate(var_fdi=ifelse((var(fdi) < quantile(var(fdi),probs = 0.01,na.rm = TRUE) | var(fdi) > quantile(var(fdi),probs = 0.99,na.rm = TRUE))
                   ,NA,
                   var(fdi))) # ELIMINACION DE DATOS ATIPICOS
fdi %>% 
  group_by(`Countries`) %>% 
  summarise(quantile(var_fdi,probs = c(0.1),na.rm = TRUE)) #VER LOS PERCENTILES POR PAISE
```

### Shocks en la FDI
Se obtiene un shock en FDI cuando se cumple que: $\Delta\frac{FDI_{i}}{PIB_{i}} < percentil^{10th}_{i}\frac{FDI_{i}}{PIB_{i}}$ donde `i= 1...n Paises`

```{r Calculo del sh en FDI,echo=FALSE}
fdi <- fdi %>% 
  group_by(Countries) %>%
  mutate(sh_fdi=ifelse(var(fdi)<(quantile(var_fdi,probs = c(0.1),na.rm = TRUE)),yes = 1,no = 0))
fdi %>% DT::datatable()
```

## Remesas

```{r selccion de la variablede remesas,echo=FALSE,message=FALSE,warning=FALSE}
rem <- filtrar(x = "BX.TRF.PWKR.DT.GD.ZS") %>% 
  rename(rem=BX.TRF.PWKR.DT.GD.ZS)
```

### Percentiles de las variaciones en las remesas
El 10mo percentil de la variacion de las remesas para cada pais son:
```{r Cuartiles de rem para cada pais,echo=FALSE}
rem <- rem %>% 
  group_by(`Countries`) %>% 
  mutate(var_rem=ifelse((var(rem) < quantile(var(rem),probs = 0.01,na.rm = TRUE) | var(rem) > quantile(var(rem),probs = 0.99,na.rm = TRUE))
                   ,NA,
                   var(rem)))
rem %>% 
  summarise(quantile(var_rem,probs = c(0.1),na.rm = TRUE))
```

### Shocks en las remesas

```{r merge con IVE y calculo de la nueva crisis,echo=FALSE}
rem <- rem %>% 
  group_by(Countries)%>% 
  mutate(sh_rem=ifelse((var(rem)<quantile(var_rem,probs = 0.1,na.rm = TRUE)),
                       yes = 1,
                       no = 0))
rem %>% DT::datatable()
```

## Ayuda

La ayuda esta medida como $\frac{Ayuda}{INB}$

### Percentiles de las variaciones de la ayuda.

El 10th percentil para cada pais de esta variable es:

```{r selccion de la variable,echo=FALSE,message=FALSE,warning=FALSE}
help <- filtrar(x = "DT.ODA.ODAT.GN.ZS") %>% rename(help=DT.ODA.ODAT.GN.ZS)

help <- help %>% 
  group_by(`Countries`) %>% 
  mutate(var_help=ifelse((var(help) < quantile(var(help),probs = 0.01,na.rm = TRUE) | var(help) > quantile(var(help),probs = 0.99,na.rm = TRUE))
                   ,NA,
                   var(help)))
help %>% 
  group_by(Countries) %>% 
  summarise(quantile(var_help,probs = 0.1,na.rm = TRUE))
```

### Shocks en la ayuda.

Las fechas de los anios donde hay shocks de variacion en la ayuda queda de la siguiente forma
```{r merge con IVE y calculo de las crisis con la ayuda,echo=FALSE,message=FALSE,warning=FALSE}
help <- help %>% 
  group_by(Countries)%>%  
  mutate(sh_help=ifelse((var(help)<quantile(var_help,probs = 0.1,na.rm = TRUE)),
                        yes = 1,
                        no = 0))
help %>% DT::datatable()
```

## Terminos de intercambio

**OJO: la metadata revela que el anio base varia de acuerdo al pais** La variable esta en dólares, por lo tanto usar su tasa de crecimiento, ya no la variacion como las anteriores.

### Percentiles de los cambios porcentuales en los TI.
```{r seleccionar los datos para los terminos de intercambio,echo=FALSE ,warning=FALSE}
tt <- filtrar("NY.TTF.GNFS.KN") %>% rename(tt=NY.TTF.GNFS.KN) 

tt <- tt %>% 
  group_by(`Countries`) %>% 
  mutate(growth_tt=ifelse((growth(tt) < quantile(growth(tt),probs = 0.01,na.rm = TRUE) | growth(tt) > quantile(growth(tt),probs = 0.99,na.rm = TRUE))
                   ,NA,
                   growth(tt)))

tt%>% group_by(Countries) %>% 
  summarise(quantile(growth(tt),
                     probs = 0.1,
                     na.rm = TRUE))
```

### Shocks en los terminos de intercambio

*OJO: Hay años donde hay valores de 0 asumo que son valores de equilibrio (Importaciones = Exportaciones). Por lo tanto, una tasa de crecimiento para el siguiente año tiende a ser infinito puesto que no se puede divir para 0. Ahora un equilibrio (0) no es malo, por lo tanto se opta por asumer como normal.*

***Queda pendiente buscar posibles soluciones para identificar shocks cuando hay estos incovenientes, por el hecho de que el siguiente año al "equilibrio" pudo haber un caida mas fuerte que de lo normal***

```{r merge del tt con la base de IVE,echo=FALSE}
tt <- tt %>% group_by(Countries) %>% 
  mutate(sh_tt=ifelse((growth(tt) < quantile(growth_tt,probs = 0.1,na.rm = TRUE)),
                                         yes = 1,
                                         no = 0),
         sh_tt=ifelse(growth_tt == -Inf ,yes = 0,no = sh_tt))

tt %>% DT::datatable()
```


## Desastres naturales

```{r Datos de los DN,echo=FALSE}
dn <- read_excel("DESASTRES NATURALES.xlsx")
dn <- dn %>% 
  select(Countries,year,`Total Damages ('000 US$)`,`Total Affected`) %>% 
  rename(per=`Total Damages ('000 US$)`,us=`Total Affected`) %>% 
  filter(year %in% c(1980:2018))
dn <- dn %>% group_by(Countries) %>%
  mutate(sh_dn=ifelse(per>quantile(per,probs = 0.25,na.rm = TRUE) & us>quantile(us,probs = 0.25,na.rm = TRUE),
                                                   yes = 1,
                                                   no = 0),
         id=paste0(Countries,year)) %>%
  data.table(key = c("Countries","year")) %>% 
  filter(sh_dn %in% c(1),Countries %in% paises$Countries)

dn <- dn[!duplicated(dn$id),]
dn <- select(dn,Countries,year,sh_dn)

```

```{r shocks identificados, echo=FALSE}
sh <- merge(x = fdi,y = rem)
sh <- merge(x = sh,y = help)
sh <- merge(x = sh,y = tt)
sh <- merge(x = sh,y = dn,all = TRUE)
sh <- select(sh,Countries, year,starts_with("sh"))
sh <- mutate(sh, sh = ifelse(test = ((sh_fdi == 1) | (sh_rem == 1) | (sh_help == 1) | (sh_tt == 1) | (sh_dn == 1)),yes = 1,no = 0))
```

```{r episodios de crisis ,message=FALSE, warning=FALSE, echo=FALSE}

ive <- ive %>% 
  group_by(Countries) %>% 
  mutate(cr = ifelse((((gdp_pc + lead(gdp_pc,1))/2) < ((lag(gdp_pc,1) + lag(gdp_pc,2) + lag(gdp_pc,3))/3)) & (g_gdppc < 0),
                     yes = 1,
                     no = 0))
```

# Identificación de los episodios de crisis.

## Regla para la identificacion de episodios de crisis.

La identificación de la variable dependiente como crisis de crecimiento requiere del cumplimiento de las siguientes condiciones propuestas por @dabla-norrisExogenousShocksGrowth2014:

  1. El nivel promedio posterior al shock de 2 años $(t, t + 1)$ del PIB real per cápita cae por debajo de la tendencia de 3 años anterior al shock. Esto es:
  $$\frac{PIB_{pc,t}+PIB_{pc,t+1}}{2}<\frac{PIB_{pc,t-3}+PIB_{pc,t-2}+PIB_{pc,t-3}}{3}$$
  
  2. El crecimiento del PIB real per cápita es negativo en el momento t. Es decir:
  $$\Delta\%{PIB_{pc,t}<0}$$.
  
# Episodios de crisis dados por shocks exógenos


```{r ,echo=FALSE}
ive <- merge(x = ive,y = sh) %>% 
  select(Countries,year, gdp_pc, g_gdppc,sh,cr) %>% 
  mutate(sh = ifelse( test = is.na(sh),yes = 0,no = sh),
         cr = ifelse( is.na(cr),0,cr),
         cr_sh = ifelse((sh == 1) & (cr == 1),yes = 1,no = 0))

ive %>% DT::datatable()
```

Como resultado total de la identifación de episodios de crisis y eventos de shocks, se puede revelar lo siguiente:
Casos de `Episodios normales = 0` y de `Episodios de crisis = 1`

```{r total los resultados, echo=FALSE}
dim <- table(ive$cr_sh)
dim
```
La  probabilidad incondicional de crisis para América Latina sería de:
```{r probabilidad incondicional,echo=FALSE}
print(dim[2]/dim[1]*100)
```

```{r}
library(plotly)
ive %>% 
  group_by(Countries) %>% 
  mutate(crisis =gdp_pc*cr_sh , crisis = ifelse(cr_sh == 0, NA, crisis) )%>%
  plot_ly(x = ~year, y = ~gdp_pc, type = 'scatter' ,mode = 'lines', color = ~Countries) %>% 
  add_trace(y = ~crisis, type = 'scatter', mode = "markers"  ,size = 0.5) %>% 
  layout(title = "PIB_pc y eventos de crisis (puntos)",
         xaxis = list(title = "Años"),
         yaxis = list (title = "PIB percápita"))
```

